<head>
    <title>订单列表</title>
    #set($layout = "/layout/layout_non.vm")
    <meta charset="UTF-8">
    <title>修改订单价格</title>
    <style type="text/css">
    body {
        font: 14px/1.25 "Microsoft YaHei", Trajan Pro, Arial, sans-serif;
        color: RGB(83, 83, 83);
    }
    
    .f16 {
        font-size: 16px;
    }
    
    .f18 {
        font-size: 18px;
    }
    
    .change-price-modal {
        padding: 10px;
    }
    
    .order-list {
        width: 100%;
        padding: 0;
        border-collapse: collapse;
        border-spacing: 0;
    }
    
    .order-list th {
        height: 34px;
        background: #f5f5f5;
        font-weight: normal;
        text-align: center;
    }
    
    .order-list td {
        height: 50px;
        text-align: center;
        border-bottom: 1px solid #f5f5f5;
    }
    
    .order-list td.name {
        text-align: left;
        padding: 0 25px;
    }
    
    .order-list td .input-text {
        width: 100px;
        height: 20px;
        padding: 5px;
        text-align: center;
        border: 1px solid #ddd;
        border-radius: 3px;
        outline: none;
        color: #ed6c44;
    }

    .order-list td .input-text.error {
        border-color: #a94442;
        -webkit-box-shadow: inset 0 1px 1px rgba(0, 0, 0, .075);
        box-shadow: inset 0 1px 1px rgba(0, 0, 0, .075);
    }
    
    .orgin-price {
        height: 40px;
        line-height: 40px;
    }
    
    .orgin-price .price,
    .real-price .price {
        color: #ed6c44;
    }
    
    .real-price {
        padding: 15px 10px 20px 0;
        border-bottom: 1px solid #f5f5f5;
        text-align: right;
    }
    
    .real-price .right {
        display: inline-block;
        width: 100%;
        margin-bottom: 10px;
    }
    
    .real-price .yh-tips {
        color: #ccc;
        font-size: 14px;
    }
    </style>
</head>
    <div id="page">
    </div>
    <script type="text/x-handlebars-template" id="tpl_change_price">
        <div class="change-price-modal">
            <div class="orgin-price">
                <span class="f16">订单原价：</span>
                <span class="price f18">{{main_order_price}}</span>
                <span class="f16">元</span>
            </div>
            <table class="order-list">
                <tr>
                    <th style="width:200px">商品名称</th>
                    <th style="width:100px">原价</th>
                    <th style="width:100px">数量</th>
                    <th style="width:100px">实付价</th>
                    <th style="width:120px">修改后价格</th>
                </tr>
                {{#each son_order_list}}
                <tr>
                    <td class="name">{{son_order_product_name}}</td>
                    <td>{{son_order_price}}</td>
                    <td>{{son_order_number}}</td>
                    <td>{{son_order_real_price}}</td>
                    <td>
                        <input class="input-text" id="{{son_order_id}}" placeholder="{{son_order_real_price}}" />
                    </td>
                </tr>
                {{/each}}
            </table>
            <div class="real-price">
                <div class="right" id="real_pay">
                </div>
                <div class="yh-tips right" id="yh_tips">
                    店铺优惠**元已均摊到每个商品
                </div>
            </div>
        </div>
    </script>
    <script src="$utilWebconfig.getStaticResourcesPath()/resources/js/jquery.js?version=20160414"></script>
    <script src="$utilWebconfig.getStaticResourcesPath()/resources/layer-v2.1/layer.js?version=20160414"></script>
    <script src="$utilWebconfig.getStaticResourcesPath()/resources/js/handlebars.js"></script>
    <script>
    function getOrderId() {
        var reg = new RegExp('(^|&)orderid=([^&]*)(&|$)', 'i');
        var r = window.location.search.substr(1).match(reg);
        if (r != null) {
            return unescape(r[2]);
        }
        return null;
    }
    var page = {
        init: function() {
            page.renderPage();
            page.attachEvent();
        },
        getOrderId: function() {
            var reg = new RegExp('(^|&)orderid=([^&]*)(&|$)', 'i');
            var r = window.location.search.substr(1).match(reg);
            if (r != null) {
                return unescape(r[2]);
            }
            return null;
        },
        renderPage: function() {
            var orderid = page.getOrderId();
            var order = parent.getOrderInfo(orderid);
            page.order = order;
            var template = Handlebars.compile($("#tpl_change_price").html());
            $(template(page.order)).appendTo("#page");
            page.formatRealPrice();
        },
        attachEvent: function() {
            $(document).on("blur", ".input-text", function() {
                var _this = $(this);
                var val = _this.val();
                if (val.length > 0) {
                    var fval = parseFloat(val);
                    _this.removeClass("error");
                    var reg = /^((?!0)\d+(\.\d{1,2})?)$/;
                    if (!reg.test(val) && isNaN(fval)) {
                        _this.addClass("error");
                    } else {
                        _this.val(fval.toFixed(2));
                    }
                }

                page.changeRealPrice();
            });
        },
        formatRealPrice: function() {
            if (page.order == null) {
                return;
            }

            var temp = [];
            temp.push('<span class="f16 ">买家实付：</span>');
            var sonOrderLength = page.order.son_order_list.length;
            if (sonOrderLength == 1) {
                temp.push('<span class="price f18">' + page.order.main_order_price + '</span><span class="f16">元</span>');
                $("#real_pay").html(temp.join(''));
                return;
            }

            //temp.push("<span>买家实付：</span>");
            for (var index = 0; index < sonOrderLength; index++) {
                var sonOrder = page.order.son_order_list[index];
                if (index == sonOrderLength - 1) {
                    temp.push('<span class="f18">' + sonOrder.son_order_real_price + '</span>');
                } else {
                    temp.push('<span class="f18">' + sonOrder.son_order_real_price + '</span>')
                    temp.push('<span class="f18">+</span>');
                }
            }
            temp.push('<span>=</span>');
            temp.push('<span class="price f18">' + page.order.main_order_price + '</span><span>元</span>');
            $("#real_pay").html(temp.join(''));
        },
        changeRealPrice: function() {
            if (page.order == null) {
                return;
            }

            var temp = [];
            var total = 0;
            var sonOrderLength = page.order.son_order_list.length;
            //单个子订单  处理
            if (sonOrderLength == 1) {
                total = $("#" + page.order.son_order_list[0].son_order_id).val();
                if (total == '' || $("#" + page.order.son_order_list[0].son_order_id).hasClass("error")) {
                    total = page.order.main_order_price;
                } else {
                    total = parseFloat(total).toFixed(2) * page.order.son_order_list[0].son_order_number;
                }

                $("#real_pay").html('<span class="f16">买家实付：</span><span class="price f18">' + total + '</span><span class="f16">元</span>');
                return;
            }

            //多个子订单处理
            temp.push('<span class="f16">买家实付：</span>');
            for (var index = 0; index < sonOrderLength; index++) {
                var sonOrder = page.order.son_order_list[index];
                var input = $("#" + sonOrder.son_order_id);
                var newPrice = input.val();
                var hasError = input.hasClass("error");

                var sonRealPrice = 0;

                if (newPrice == "" || hasError) {
                    sonRealPrice = parseFloat(sonOrder.son_order_real_price);
                } else {
                    sonRealPrice = parseFloat(newPrice) * sonOrder.son_order_number;
                }

                if (index == sonOrderLength - 1) {
                    temp.push('<span class="f18">' + sonRealPrice + '</span>');
                } else {
                    temp.push('<span class="f18">' + sonRealPrice + '</span>');
                    temp.push('<span class="f18">+</span>');
                }

                total += sonRealPrice;
            }
            temp.push('<span class="f18">=</span><span class="price f18">' + total.toFixed(2) + '</span><span class="f16">元</span>');
            $("#real_pay").html(temp.join(''));
        },
        isValid: function() {
            var result = {
                isValid: false,
                msg: ""
            };

            if ($(".input-text.error").length > 0) {
                result.msg = "请输入正确的修改后价格";
                return result;
            }

            $(".input-text").each(function() {
                if ($(this).val() != "") {
                    result.isValid = true;
                    return;
                }
            });
            if (!result.isValid) {
                result.msg = "请至少输入一个修改后价格。";
            }
            return result;
        },
        getChangedResult: function() {
            var newOrder = {};
            newOrder.main_order_id = page.order.main_order_id;
            newOrder.main_order_price = 0;
            newOrder.son_order_list = [];
            $.each(page.order.son_order_list, function(i, son) {
                var input = $("#" + son.son_order_id);
                var newPrice = input.val();
                if (newPrice.length > 0) {
                    newOrder.son_order_list.push({
                        son_order_id: son.son_order_id,
                        son_order_number: son.son_order_number,
                        son_order_price: parseFloat(newPrice)
                    });
                    newOrder.main_order_price += parseFloat(newPrice) * son.son_order_number;
                } else {
                    newOrder.main_order_price += parseFloat(son.son_order_real_price);
                }
            });

            return newOrder;
        }
    };
    $(function() {
        page.init();
        var index = parent.layer.getFrameIndex(window.name);
        parent.layer.iframeAuto(index);
    });
    </script>
</body>