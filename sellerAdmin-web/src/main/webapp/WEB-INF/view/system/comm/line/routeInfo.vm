<!--
<script src="$!{utilWebconfig.getStaticResourcesPath()}/resources/js/layerModal.js" type="text/javascript"></script>
-->
<div class="tripInfo">
	<ul id="day_tab" class="nav nav-tabs tripInfoNav">
		#foreach($tripDay in $product.tripInfo)
		<li class='day_${velocityCount}_tab day_tab #if(${velocityCount}==1) active #end' day-id='${velocityCount}'>
			<a href='#day_${velocityCount}_page' data-toggle='tab' class='day_tab_a'>Day</a><i class='icon icon-trash myTrash'></i>
		</li>
		#end
        <li class="day_btn">
          <button class='btn btn-primary addDay'>添加1天</button>
		  <script type="text/javascript">
		  	var dayId;
			$(function() {
        		dayId = $(".day_tab").length;
				show();
        	});

			$(document).delegate(".myTrash","click",function(){
				var tab = $(this).parent();
				var day = tab.attr("day-id");
				// 删除当前的
				setAllRouteItem(day,deletedRouteItems);
				// 更新后续所有
				tab.nextAll().each(function() {
					var _day = $(this).attr("day-id");
					setAllRouteItem(_day,updatedRouteItems);
				});
                var tabConId = $(this).prev().attr("href");
                $(".tripInfo .tab-content .tab-pane").removeClass("active");
                $(".tripInfoNav .day_tab").removeClass("active");
				if($(tabConId).prev().length != 0){
                    $(tabConId).prev().addClass("active");
                    $(tabConId).remove();
				}else{
                    $(tabConId).remove();
					$(".tripInfo .tab-content .tab-pane:first").addClass("active");
				}
				if($(this).parent().prev().length != 0){
                    $(this).parent().prev().addClass("active");
                    $(this).parent().remove();
				}else{
                    $(this).parent().remove();
					$(".tripInfoNav .day_tab:first").addClass("active");
                }
				show();
			});

		  	$(".addDay").click(function() {
				dayId = dayId + 1;
				var tab = createDayTab(dayId);
				var page = createDayPage(dayId);
				$(".day_btn").before(tab);
				$(".tab-content").append(page);
				tab.children("a").click();
				show();
			});
			//重新计算day_tab显示天数
			function show() {
				$(".day_tab_a").each(function(idx,el){
					$(el).text("Day"+(idx+1));
				});
			}
			// 创建一天的Tab
			function createDayTab(dayId) {
				var li = $("<li class='day_"+dayId+"_tab day_tab' day-id='"+dayId+"'></li>");
				li.append($("<a href='#day_"+dayId+"_page' data-toggle='tab' class='day_tab_a'>Day</a><i class='icon icon-trash myTrash'></i>"));
				return li;
			}
			// 添加餐厅
			$(document).delegate(".add-restaurant-btn","click",function(){
				var _currentrid = $(this).attr("display-id");
				var content = $("#"+_currentrid);
				var rname = $("#"+_currentrid+"_add").val();
				if(rname) {
					var btn = $("<button class='btn btn-default "+_currentrid+"_item'></button>");
					btn.attr("rid", 0);
					btn.attr("rname", rname);
					btn.click(function() {
						$(this).remove();
					});
					content.append(btn.text(rname));
					$("#"+_currentrid+"_add").val("");
				}
				// update
				var route_item_id = content.attr("route-item-id");
				var route_item_detail_id = content.attr("route-item-detail-id");
				setRouteItem(route_item_id,route_item_detail_id,updatedRouteItems);
			});
            // 添加景区
            $(document).delegate(".add-scenic-btn","click",function(){
                var _currentrid = $(this).attr("display-id");
                var content = $("#"+_currentrid);
                var rname = $("#"+_currentrid+"_add").val();
                if(rname) {
                    var btn = $("<button class='btn btn-default "+_currentrid+"_item'></button>");
                    btn.attr("rid", 0);
                    btn.attr("rname", rname);
                    btn.click(function() {
                        $(this).remove();
                    });
                    content.append(btn.text(rname));
                    $("#"+_currentrid+"_add").val("");
                }
                // update
                var route_item_id = content.attr("route-item-id");
                var route_item_detail_id = content.attr("route-item-detail-id");
                setRouteItem(route_item_id,route_item_detail_id,updatedRouteItems);
            });
            // 添加酒店
            $(document).delegate(".add-hotel-btn","click",function(){
                var _currentrid = $(this).attr("display-id");
                var content = $("#"+_currentrid);
                var rname = $("#"+_currentrid+"_add").val();
                if(rname) {
                    var btn = $("<button class='btn btn-default "+_currentrid+"_item'></button>");
                    btn.attr("rid", 0);
                    btn.attr("rname", rname);
                    btn.click(function() {
                        $(this).remove();
                    });
                    content.append(btn.text(rname));
                    $("#"+_currentrid+"_add").val("");
                }
                // update
                var route_item_id = content.attr("route-item-id");
                var route_item_detail_id = content.attr("route-item-detail-id");
                setRouteItem(route_item_id,route_item_detail_id,updatedRouteItems);
            });

			// 创建一天的page
			function createDayPage(dayId) {
				var page = $("<div class='tab-pane' id='day_"+dayId+"_page'></div>");
				// 行程描述
				var desc = $("<div class='panel trip-description'></div>");
                desc.append($("<div class='panel-heading travelPanel'><i class='icon icon-2x icon-exclamation-sign'></i><span class='tripAddSp'>行程描述</span></div>"));
                var desc_content = $("<div class='panel-body trip-description-content'></div>");
				desc_content.append($("<textarea class='form-control' rows='3' id='day_"+dayId+"_trip_description'></textarea>"));
                desc.append(desc_content);	
				page.append(desc);
				// 行程图片
				var images = $("<div class='panel trip-images'></div>");
                images.append($("<div class='panel-heading travelPanel'><i class='icon icon-2x icon-exclamation-sign'></i><span class='tripAddSp'>行程图片</span></div>"));
                var images_content = $("<div class='panel-body trip-images-content'></div>");
				
                images.append(images_content);	
				page.append(images);
				return page;
			}
          </script>
        </li>
    </ul>
    <div class="tab-content">
		#foreach($tripDay in $product.routeInfo.routeDays)
		#set($day = ${velocityCount})
		<div class="tab-pane in #if(${day}==1) active #end" id="day_${velocityCount}_page">
			<div class="panel trip-description">
				<div class="panel-heading travelPanel"><i class="icon icon-2x icon-exclamation-sign"></i><span class="tripAddSp">行程描述</span></div>
				<div class="panel-body trip-description-content">
					<textarea class="form-control trip-description-textarea" rows="3" id="day_${velocityCount}_trip_description" route-item-id="$!{tripDay.descriptionRouteItemId}">$!{tripDay.description}</textarea>
				</div>
			</div>
			<div class="panel trip-images">
				<div class="panel-heading travelPanel"><i class="icon icon-2x icon-exclamation-sign"></i><span class="tripAddSp">行程图片</span></div>
				<div class="panel-body trip-images-content">
					
				</div>
			</div>
		</div>
		#end
    </div>
	<script type="text/javascript">
		// 自删除按钮
		$(document).delegate(".remove-self","click",function(){
			// update
			var content = $(this).parent();
			var route_item_id = content.attr("route-item-id");
			var route_item_detail_id = content.attr("route-item-detail-id");
			setRouteItem(route_item_id,route_item_detail_id,updatedRouteItems);
			$(this).remove();
		});
		var currentTId;
		var currentrid;
		var currentSId;
		var currentHId;
	    // 选择交通
		$(".select-traffic").click(selectTraffic);
		var ways = {
			0:"未知"
			#foreach($way in $ways)
			,$!{way.key}:"$!{way.value}"
			#end
		};
		function selectTraffic(){
			var currentTId = $(this).attr("display-id");
			openModalForForm('$!{utilWebconfig.getActionDefaultFontPath()}/B2C/comm/groupTravel/selectTraffic','选择交通方式 ',function() {
				var tra = win.getTraffic();
				var content = $("#"+currentTId);
				content.empty();
				var from = $("<span class='label label-info' id='"+currentTId+"_from' rname='"+tra.from+"'>"+tra.from+"</span>");
				var way = $("<span class='label label-info' id='"+currentTId+"_way' rid='"+tra.way+"'>"+ways[tra.way]+"</span>");
				var to = $("<span class='label label-info' id='"+currentTId+"_to' rname='"+tra.to+"'>"+tra.to+"</span>");
				content.append(from).append(way).append(to);
				// console.log(JSON.stringify(tra));
				// update
				var route_item_id = content.attr("route-item-id");
				setRouteItem(route_item_id,false,updatedRouteItems);
				// 一般设定yes回调，必须进行手工关闭
				return true;
			});
        }
		$(".trip-description-textarea").change(function() {
			// update
			var route_item_id = $(this).attr("route-item-id");
			setRouteItem(route_item_id,false,updatedRouteItems);
		});
		// 选择餐厅
		$(".select-restaurant").click(selectRestaurant);
		function selectRestaurant(){
			currentrid = $(this).attr("display-id");
			openModalForForm('$!{utilWebconfig.getActionDefaultFontPath()}/B2C/resourceForSelect/selectRestaurant','选择餐厅',function() {
				var res = win.getItems();
				var content = $("#"+currentrid);
                for(var i in res) {
					if($("#"+currentrid+"_item_"+res[i].id).length > 0) continue;
					var btn = $("<button class='btn btn-info "+currentrid+"_item remove-self' id='"+currentrid+"_item_"+res[i].id+"'></button>");
					btn.attr("rid", res[i].id);
					btn.attr("rname", res[i].name);
					content.append(btn.text(res[i].name));
				}
				//console.log(JSON.stringify(res));
				// update
				var route_item_id = content.attr("route-item-id");
				var route_item_detail_id = content.attr("route-item-detail-id");
				setRouteItem(route_item_id,route_item_detail_id,updatedRouteItems);
				//返回true成功关闭
				return true;
			});
        }
		
		// 选择景区
		$(".select-scenic").click(selectScenic);
		function selectScenic(){
			currentSId = $(this).attr("display-id");
			openModalForForm('$!{utilWebconfig.getActionDefaultFontPath()}/B2C/resourceForSelect/selectScenic','选择景区',function() {
				var sce = win.getItems(); 
				var content = $("#"+currentSId);
//				content.empty();
                for(var i in sce) {
					var btn = $("<button class='btn btn-info "+currentSId+"_item remove-self'></button>");
					btn.attr("rid", sce[i].id);
					btn.attr("rname", sce[i].name);
					content.append(btn.text(sce[i].name));
				}
				//console.log(JSON.stringify(tra));
				// update
				var route_item_id = content.attr("route-item-id");
				var route_item_detail_id = content.attr("route-item-detail-id");
				setRouteItem(route_item_id,route_item_detail_id,updatedRouteItems);
				//一般设定yes回调，必须进行手工关闭
				return true;
			});
        }
		$(".select-hotel").click(selectHotel);
		// 选择酒店
		function selectHotel(){
			currentHId = $(this).attr("display-id");
			openModalForForm('$!{utilWebconfig.getActionDefaultFontPath()}/B2C/resourceForSelect/selectHotel','选择酒店 ',function() {
				var hot = win.getItems(); 
				var content = $("#"+currentHId);
//				content.empty();
                for(var i in hot) {
					var btn = $("<button class='btn btn-info "+currentHId+"_item remove-self'></button>");
					btn.attr("rid", hot[i].id);
					btn.attr("rname", hot[i].name);
					content.append(btn.text(hot[i].name));
				}
				//console.log(JSON.stringify(hot));
				// update
				var route_item_id = content.attr("route-item-id");
				var route_item_detail_id = content.attr("route-item-detail-id");
				setRouteItem(route_item_id,route_item_detail_id,updatedRouteItems);
				//一般设定yes回调，必须进行手工关闭
				return true;
			});
        }
		var updatedRouteItems=[];
		var deletedRouteItems=[];
		// 设置更新
		function setRouteItem(item_id,detail_id,arr) {
			// TODO 设置更新
			if(item_id&&item_id>0) {
				arr.push(item_id);
			}
			if(detail_id&&detail_id>0) {
				arr.push(detail_id);
			}
			// alert(arr);
		}
		// 设置全更新
		function setAllRouteItem(day,arr) {
			var traffic_content = $("#day_"+day+"_traffic");
			var route_item_id = traffic_content.attr("route-item-id");
			setRouteItem(route_item_id,null,arr);
			
			var description_content = $("#day_"+day+"_trip_description");
			route_item_id = description_content.attr("route-item-id");
			setRouteItem(route_item_id,null,arr);
			
			var restaurant_1_content = $("#day_"+day+"_restaurant_1");
			route_item_id = restaurant_1_content.attr("route-item-id");
			var route_item_detail_id = restaurant_1_content.attr("route-item-detail-id");
			setRouteItem(route_item_id,route_item_detail_id,arr);
			
			var restaurant_2_content = $("#day_"+day+"_restaurant_2");
			route_item_id = restaurant_2_content.attr("route-item-id");
			route_item_detail_id = restaurant_2_content.attr("route-item-detail-id");
			setRouteItem(route_item_id,route_item_detail_id,arr);
			
			var restaurant_3_content = $("#day_"+day+"_restaurant_3");
			route_item_id = restaurant_3_content.attr("route-item-id");
			route_item_detail_id = restaurant_3_content.attr("route-item-detail-id");
			setRouteItem(route_item_id,route_item_detail_id,arr);
			
			var scenic_content = $("#day_"+day+"_scenic");
			route_item_id = scenic_content.attr("route-item-id");
			route_item_detail_id = scenic_content.attr("route-item-detail-id");
			setRouteItem(route_item_id,route_item_detail_id,arr);
			
			var hote_content = $("#day_"+day+"_hotel");
			route_item_id = hote_content.attr("route-item-id");
			route_item_detail_id = hote_content.attr("route-item-detail-id");
			setRouteItem(route_item_id,route_item_detail_id,arr);
		}
		function getUpdatedRouteItems() {
			return updatedRouteItems;
		}
		function getDeletedRouteItems() {
			return deletedRouteItems;
		}
		// 获取行程信息
		function getTripInfo() {
			var result = [];
			$(".day_tab").each(function(){
				var day_id = $(this).attr("day-id");
				var day = {id:day_id};
				// 交通方式
				var tra = {};
				var _from = $("#day_"+day_id+"_traffic_from");
				var _to = $("#day_"+day_id+"_traffic_to");
				var _way = $("#day_"+day_id+"_traffic_way");
				if(_from.length > 0 || _to.length > 0 || _way.length > 0) {
    				if(_from.length > 0) {
    					tra["from"] = _from.attr("rname");
    				}
    				if(_to.length > 0) {
    					tra["to"] = _to.attr("rname");
    				}
    				if(_way.length > 0) {
    					tra["way"] = _way.attr("rid");
					}
					day["trafficRouteItemId"] = $("#day_"+day_id+"_traffic").attr("route-item-id");
					day["traffic"] = tra;
				}
				// 描述
				day["descriptionRouteItemId"] = $("#day_"+day_id+"_trip_description").attr("route-item-id");
				day["description"] = $("#day_"+day_id+"_trip_description").val()||"";
				// 餐厅
				day["breakfastRouteItemId"] = $("#day_"+day_id+"_restaurant_1").attr("route-item-id");
				var res_1 = [];
				$(".day_"+day_id+"_restaurant_1_item").each(function(){
					var rid = $(this).attr("rid");
					var rname = $(this).attr("rname");
					res_1.push({id:rid,name:rname});
				});
				day["restaurant1"] = res_1;
				
				day["lunchRouteItemId"] = $("#day_"+day_id+"_restaurant_2").attr("route-item-id");
				var res_2 = [];
				$(".day_"+day_id+"_restaurant_2_item").each(function(){
					var rid = $(this).attr("rid");
					var rname = $(this).attr("rname");
					res_2.push({id:rid,name:rname});
				});
				day["restaurant2"] = res_2;
				
				day["dinnerRouteItemId"] = $("#day_"+day_id+"_restaurant_3").attr("route-item-id");
				var res_3 = [];
				$(".day_"+day_id+"_restaurant_3_item").each(function(){
					var rid = $(this).attr("rid");
					var rname = $(this).attr("rname");
					res_3.push({id:rid,name:rname});
				});
				day["restaurant3"] = res_3;
				// 景点
				day["scenicsRouteItemId"] = $("#day_"+day_id+"_scenic").attr("route-item-id");
				day["scenicDetailRouteItemId"] = $("#day_"+day_id+"_scenic").attr("route-item-detail-id");
				var sce = [];
				$(".day_"+day_id+"_scenic_item").each(function(){
					var rid = $(this).attr("rid");
					var rname = $(this).attr("rname");
					sce.push({id:rid,name:rname});
				});
				day["scenics"] = sce;
				
				// 酒店
				day["hotelsRouteItemId"] = $("#day_"+day_id+"_hotel").attr("route-item-id");
				day["hotelDetailRouteItemId"] = $("#day_"+day_id+"_hotel").attr("route-item-detail-id");
				var hotel = [];
				$(".day_"+day_id+"_hotel_item").each(function(){
					var rid = $(this).attr("rid");
					var rname = $(this).attr("rname");
					hotel.push({id:rid,name:rname});
				});
				day["hotels"] = hotel;
				
				result.push(day);
			});
			// alert(JSON.stringify(result));
			return result;
		}
		
		function getRouteInfo() {
			return {
				#if($!{product.routeInfo})
				routeId: $!{product.routeInfo.routeId},
				#end
				routeDays:getTripInfo(),
    			updatedRouteItems:getUpdatedRouteItems(),
    			deletedRouteItems:getDeletedRouteItems()
			};
		}
    </script>
</div>